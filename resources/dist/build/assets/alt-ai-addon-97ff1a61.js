function k(t){const e=t.view.dom.closest(".bard-fieldtype");if(!e)return null;let i=e.querySelector(".ai-loading-overlay");return i||(i=document.createElement("div"),i.className="ai-loading-overlay",i.innerHTML=`
        <div class="ai-loading-spinner">
            <svg class="ai-spinner-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" opacity="0.25"/>
                <path d="M12 2a10 10 0 0 1 10 10"/>
            </svg>
            <div class="ai-loading-text">AI Processing...</div>
        </div>
    `,getComputedStyle(e).position==="static"&&(e.style.position="relative"),e.appendChild(i),i)}function C(t){t&&t.parentNode&&t.parentNode.removeChild(t)}class F{constructor(){this.modal=null,this.conversation=[],this.currentEditor=null}create(n){this.currentEditor=n;const e=document.createElement("div");e.className="ai-agent-modal-overlay",e.innerHTML=`
            <div class="ai-agent-modal">
                <div class="ai-agent-header">
                    <div class="ai-agent-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <span>AI Writing Agent</span>
                    </div>
                    <button class="ai-agent-close" title="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="ai-agent-messages"></div>
                <div class="ai-agent-input-area">
                    <textarea class="ai-agent-input" placeholder="Ask the AI to help with your content... (e.g., 'Make this more formal', 'Add more detail about X', 'Suggest improvements')" rows="2"></textarea>
                    <button class="ai-agent-send" title="Send (Enter)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        `,document.body.appendChild(e),this.modal=e;const i=e.querySelector(".ai-agent-messages");this.conversation.length===0?this.showEmptyState(i):this.renderConversation(i),this.setupEventListeners(e,n)}showEmptyState(n){n.innerHTML=`
            <div class="ai-agent-empty">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <p><strong>AI Writing Agent is ready!</strong></p>
                <p>I can help you with your content. Ask me to improve text, add details, change tone, or make suggestions.</p>
                <p style="margin-top: 16px; font-size: 13px; color: #9ca3af;">I have access to your full document and any selected text.</p>
            </div>
        `}setupEventListeners(n,e){const i=n.querySelector(".ai-agent-close"),o=n.querySelector(".ai-agent-send"),s=n.querySelector(".ai-agent-input");i.onclick=()=>this.close(),n.onclick=a=>{a.target===n&&this.close()},o.onclick=()=>this.sendMessage(e,s),s.onkeydown=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.sendMessage(e,s))},s.focus()}close(){this.modal&&(this.modal.remove(),this.modal=null)}renderConversation(n){n.innerHTML=this.conversation.map(e=>`
            <div class="ai-agent-message ${e.role}">
                <div class="ai-agent-message-content">${e.content.replace(/\n/g,"<br>")}</div>
                ${e.role==="assistant"&&e.content.length>50?`
                    <div class="ai-agent-message-actions">
                        <button class="ai-agent-action-btn" onclick="window.applyAgentSuggestion('${escape(e.content)}')">
                            Apply to Editor
                        </button>
                    </div>
                `:""}
            </div>
        `).join(""),n.scrollTop=n.scrollHeight}showLoading(n){const e=document.createElement("div");e.className="ai-agent-message assistant",e.innerHTML='<div class="ai-agent-loading"><span></span><span></span><span></span></div>',n.appendChild(e),n.scrollTop=n.scrollHeight}async sendMessage(n,e){var c,u,f,l,d;const i=e.value.trim();if(!i)return;const o=this.modal.querySelector(".ai-agent-messages"),s=this.modal.querySelector(".ai-agent-send"),r=((d=(((l=(f=(u=(c=Statamic.$store)==null?void 0:c.state)==null?void 0:u.statamic)==null?void 0:f.config)==null?void 0:l.altAiConfig)||{}).endpoints)==null?void 0:d.agent)||"/cp/alt-ai/agent";this.conversation.push({role:"user",content:i}),e.value="",e.disabled=!0,s.disabled=!0,this.renderConversation(o),this.showLoading(o);try{const g=n.state.doc.textBetween(0,n.state.doc.content.size,`
`),{from:v,to:p}=n.state.selection,m=n.state.doc.textBetween(v,p," "),h=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":Statamic.$config.get("csrfToken"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({message:i,document_content:g,selected_text:m,conversation_history:this.conversation.slice(0,-1).slice(-10)})});if(!h.ok)throw new Error(`Server error: ${h.status}`);const w=await h.json();this.conversation.push({role:"assistant",content:w.message}),this.renderConversation(o)}catch(g){console.error("AI Agent error:",g),this.conversation.push({role:"assistant",content:"Sorry, I encountered an error. Please try again. "+g.message}),this.renderConversation(o)}finally{e.disabled=!1,s.disabled=!1,e.focus()}}applySuggestion(n){if(this.currentEditor){const e=unescape(n),{from:i,to:o}=this.currentEditor.state.selection;i!==o?this.currentEditor.commands.insertContentAt({from:i,to:o},e):this.currentEditor.commands.insertContent(e),this.close()}}}const R="modulepreload",V=function(t){return"/build/"+t},I={},D=function(n,e,i){if(!e||e.length===0)return n();const o=document.getElementsByTagName("link");return Promise.all(e.map(s=>{if(s=V(s),s in I)return;I[s]=!0;const a=s.endsWith(".css"),r=a?'[rel="stylesheet"]':"";if(!!i)for(let f=o.length-1;f>=0;f--){const l=o[f];if(l.href===s&&(!a||l.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${r}`))return;const u=document.createElement("link");if(u.rel=a?"stylesheet":R,a||(u.as="script",u.crossOrigin=""),u.href=s,document.head.appendChild(u),a)return new Promise((f,l)=>{u.addEventListener("load",f),u.addEventListener("error",()=>l(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>n()).catch(s=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=s,window.dispatchEvent(a),!a.defaultPrevented)throw s})};async function A(t,n,e){var r,c,u;const{buildPrompts:i}=await D(()=>import("./ai-prompt-builder-76e18902.js"),[]),o=i(t,n),s=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model.name,messages:[{role:"system",content:o.system},{role:"user",content:o.user}],temperature:e.model.temperature,max_tokens:e.model.max_tokens})});if(!s.ok){const f=await s.json().catch(()=>({}));throw new Error(`OpenAI API error: ${s.statusText} - ${((r=f.error)==null?void 0:r.message)||""}`)}return((u=(c=(await s.json()).choices[0])==null?void 0:c.message)==null?void 0:u.content)||""}function q(t){return{aiComplete:()=>({editor:n})=>(async()=>{if(!t.options.capabilities.completion)return!1;const{from:e,to:i}=n.state.selection,o=n.state.doc.textBetween(0,i," "),s=k(n);try{const a=await A("completion",{text:o},t.options);return a&&n.commands.insertContent(a),!0}catch(a){return console.error("AI Completion error:",a),!1}finally{C(s)}})(),aiEnhance:()=>({editor:n})=>(async()=>{if(!t.options.capabilities.enhancement)return!1;const{from:e,to:i}=n.state.selection,o=n.state.doc.textBetween(e,i," ");if(!o)return!1;const s=k(n);try{const a=await A("enhance",{text:o},t.options);return a&&n.commands.insertContentAt({from:e,to:i},a),!0}catch(a){return console.error("AI Enhancement error:",a),!1}finally{C(s)}})(),aiSummarize:()=>({editor:n})=>(async()=>{if(!t.options.capabilities.summarization)return!1;const{from:e,to:i}=n.state.selection,o=n.state.doc.textBetween(e,i," ");if(!o)return!1;const s=k(n);try{const a=await A("summarize",{text:o},t.options);return a&&n.commands.insertContentAt(i+1,`

Summary: ${a}`),!0}catch(a){return console.error("AI Summarization error:",a),!1}finally{C(s)}})(),aiTranslate:n=>({editor:e})=>(async()=>{if(!t.options.capabilities.translation)return!1;const{from:i,to:o}=e.state.selection,s=e.state.doc.textBetween(i,o," ");if(!s)return!1;const a=k(e);try{const r=await A("translate",{text:s,target_language:n},t.options);return r&&e.commands.insertContentAt({from:i,to:o},r),!0}catch(r){return console.error("AI Translation error:",r),!1}finally{C(a)}})(),aiAdjustTone:n=>({editor:e})=>(async()=>{if(!t.options.capabilities.tone_adjustment)return!1;const{from:i,to:o}=e.state.selection,s=e.state.doc.textBetween(i,o," ");if(!s)return!1;const a=k(e);try{const r=await A("adjust_tone",{text:s,tone:n},t.options);return r&&e.commands.insertContentAt({from:i,to:o},r),!0}catch(r){return console.error("AI Tone Adjustment error:",r),!1}finally{C(a)}})()}}let $=null;function N(){if(typeof Statamic>"u"||!Statamic.$bard){setTimeout(N,100);return}$=new F,Statamic.$bard.addExtension(()=>Statamic.$bard.tiptap.core.Extension.create({name:"aiAgent",addOptions(){var e,i,o,s;const n=((s=(o=(i=(e=Statamic.$store)==null?void 0:e.state)==null?void 0:i.statamic)==null?void 0:o.config)==null?void 0:s.altAiConfig)||{};return{apiKey:n.apiKey||"",capabilities:n.capabilities||{completion:!0,enhancement:!0,summarization:!0,translation:!0,tone_adjustment:!0},model:n.model||{name:"gpt-4",temperature:.7,max_tokens:2e3},ui:n.ui||{floating_menu:!0,keyboard_shortcuts:!0,show_suggestions:!0}}},addKeyboardShortcuts(){const n={};return this.options.ui.keyboard_shortcuts&&(n["Mod-Space"]=()=>this.editor.commands.aiComplete(),n["Mod-Shift-e"]=()=>this.editor.commands.aiEnhance()),n},onCreate(){this.options.apiKey||console.warn("TipTap AI Agent: API key not configured. Please set OPENAI_API_KEY in your .env file.")},addCommands(){return q(this)}})),window.applyAgentSuggestion=t=>{$&&$.applySuggestion(t)},Statamic.$bard.buttons((t,n)=>[n({name:"aiAgent",text:__("AI Agent"),html:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',command:e=>$.create(e)}),n({name:"aiComplete",text:__("AI Complete"),html:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>',command:e=>e.commands.aiComplete()}),n({name:"aiEnhance",text:__("AI Enhance"),html:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',command:e=>e.commands.aiEnhance()}),n({name:"aiSummarize",text:__("AI Summarize"),html:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h10"/></svg>',command:e=>e.commands.aiSummarize()})])}function L(t){if(!t||typeof t!="object")return"";let n="";const e=i=>{i.text&&(n+=i.text),i.content&&Array.isArray(i.content)&&i.content.forEach(o=>{e(o),(o.type==="paragraph"||o.type==="heading")&&(n+=" ")})};return t.content&&Array.isArray(t.content)?t.content.forEach(i=>{e(i)}):e(t),n.trim()}function M(){const t={route:window.location.pathname},n=window.location.pathname.split("/");if(n.includes("collections")){const e=n.indexOf("collections");n[e+1]&&(t.collection=n[e+1])}if(n.includes("taxonomies")){const e=n.indexOf("taxonomies");n[e+1]&&(t.taxonomy=n[e+1])}if(n.includes("globals")){const e=n.indexOf("globals");n[e+1]&&(t.global=n[e+1])}if(n.includes("entries")){const e=n.indexOf("entries");n[e+1]&&n[e+1]!=="create"&&(t.entry_id=n[e+1])}try{let e=null;if(Statamic.$store&&Statamic.$store.state&&Statamic.$store.state.publish){const i=["base","default","entry","term","global"];for(const o of i)if(Statamic.$store.state.publish[o]){e={values:Statamic.$store.state.publish[o].values||{},blueprint:Statamic.$store.state.publish[o].blueprint||null,meta:Statamic.$store.state.publish[o].meta||{},site:Statamic.$store.state.publish[o].site||null,isRoot:Statamic.$store.state.publish[o].isRoot||!1};break}}if((!e||Object.keys(e.values).length===0)&&Statamic.$app&&Statamic.$app.$children){const i=s=>{if(!s)return null;if(s.$options&&s.$options.name==="publish-form")return s;if(s.$refs&&s.$refs.publish)return s.$refs.publish;if(s.$children&&s.$children.length>0)for(let a of s.$children){const r=i(a);if(r)return r}return null},o=i(Statamic.$app);o&&(e={values:o.values||{},blueprint:o.blueprint||null,meta:o.meta||{},site:o.site||null,isRoot:o.isRoot||!1})}if(e&&e.values){e.blueprint&&(typeof e.blueprint=="string"?t.blueprint=e.blueprint:typeof e.blueprint=="object"&&e.blueprint!==null&&(t.blueprint=e.blueprint.handle||e.blueprint.name||e.blueprint.namespace||null)),t.field_labels={},e.blueprint&&typeof e.blueprint=="object"&&e.blueprint.tabs&&e.blueprint.tabs.forEach(o=>{o.sections&&Array.isArray(o.sections)&&o.sections.forEach(s=>{s.fields&&Array.isArray(s.fields)&&s.fields.forEach(a=>{a.handle&&a.display&&(t.field_labels[a.handle]=a.display)})})}),e.values.title&&(t.title=e.values.title),e.values.slug&&(t.slug=e.values.slug),e.values.published!==void 0&&(t.status=e.values.published?"published":"draft"),t.fields={};const i=["id","blueprint","published","slug","title","updated_by","updated_at","created_at","origin","site","locale"];Object.keys(e.values).forEach(o=>{if(i.includes(o))return;const s=e.values[o];if(s==null||s==="")return;let a=s;if(Array.isArray(s)){if(s.length===0)return;if(s.length>0&&s.every(c=>typeof c=="object"&&(c.type==="paragraph"||c.type==="heading"||c.type==="set"||c.content))){let c="";if(s.forEach(u=>{const f=L(u);f&&(c+=f+" ")}),a=c.trim(),!a||a.length===0)return}else a=s}else if(typeof s=="object"&&s.content){if(a=L(s),!a||a.trim().length===0)return}else typeof s=="object"?s.value!==void 0?a=s.value:s.url?a=s.url:s.path?a=s.path:a=s:a=s;t.fields[o]=a}),e.values.date&&(t.date=e.values.date),e.values.created_at&&(t.created_at=e.values.created_at),e.values.updated_at&&(t.updated_at=e.values.updated_at),e.values.categories&&Array.isArray(e.values.categories)&&(t.categories=e.values.categories),e.values.tags&&Array.isArray(e.values.tags)&&(t.tags=e.values.tags),e.values.author&&(t.author=e.values.author),e.values.parent&&(t.parent=e.values.parent),e.meta&&e.meta.permalink&&(t.permalink=e.meta.permalink),e.site&&(t.site=e.site),e.locale&&(t.locale=e.locale),e.collection&&(t.collection=e.collection),e.isRoot!==void 0&&(t.is_root=e.isRoot)}if(Statamic.$config&&typeof Statamic.$config.get=="function"){const i=Statamic.$config.get("user");i&&(t.current_user={name:i.name||i.email,email:i.email,id:i.id});const o=Statamic.$config.get("selectedSite");o&&!t.site&&(t.site=o);const s=Statamic.$config.get("multisiteEnabled");s!==void 0&&(t.multisite=s)}}catch{}if(!t.title){const e=document.querySelector('input[name="title"]');e&&e.value&&(t.title=e.value)}if(!t.blueprint){const e=document.querySelector("[data-blueprint]");e&&(t.blueprint=e.getAttribute("data-blueprint"))}return n.includes("collections")?t.page_type="collection_entry":n.includes("taxonomies")?t.page_type="taxonomy_term":n.includes("globals")?t.page_type="global":n.includes("assets")?t.page_type="asset":n.includes("navigation")?t.page_type="navigation":t.page_type="other",t}function H(){return`
        <div class="chat-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="chat-badge hidden">0</span>
        </div>
        <div class="chat-window hidden">
            <div class="chat-header">
                <div class="chat-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/>
                    </svg>
                    <span>Alt AI</span>
                </div>
                <div class="chat-actions">
                    <button class="chat-btn-icon chat-clear" title="Clear conversation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                    <button class="chat-btn-icon chat-minimize" title="Minimize">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="chat-messages"></div>
            <div class="chat-input-area">
                <textarea class="chat-input" placeholder="Ask away!" rows="1"></textarea>
                <button class="chat-update-fields" title="Request AI to suggest field updates">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="chat-send" title="Send (Enter)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    `}function P(){return`
        <div class="chat-empty">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <p style="font-size: 16px; font-weight: 600; color: #1f2937; margin: 12px 0 8px;">Hi! I'm your AI assistant.</p>
            <p style="font-size: 14px; color: #6b7280; margin: 0;">I can help you with content creation, editing, and questions about what you're working on.</p>
        </div>
    `}function U(){return'<div class="chat-message-content"><div class="chat-loading"><span></span><span></span><span></span></div></div>'}function G(t,n){let e=`<div class="chat-message ${t.role}">`;return e+=`<div class="chat-message-content">${t.content.replace(/\n/g,"<br>")}</div>`,t.field_updates&&t.field_updates.changes&&t.field_updates.changes.length>0&&(e+='<div class="field-updates-card">',e+=`<div class="field-updates-header">Proposed Field Changes (${t.field_updates.changes.length})</div>`,t.field_updates.changes.forEach(i=>{const o=i.field.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()),s=i.current_value||"(empty)",a=i.proposed_value,r=i.reason||"";e+='<div class="field-change-item">',e+=`<div class="field-change-field">${o}</div>`,e+='<div class="field-change-values">',e+=`<div class="field-change-current">Current: ${s}</div>`,e+=`<div class="field-change-proposed">Proposed: ${a}</div>`,r&&(e+=`<div class="field-change-reason">${r}</div>`),e+="</div></div>"}),t.field_updates.applied?e+='<div class="field-updates-applied">✓ Changes Applied</div>':(e+='<div class="field-updates-actions">',e+=`<button class="apply-changes-btn" data-message-index="${n}">Apply Changes</button>`,e+=`<button class="cancel-changes-btn" data-message-index="${n}">Dismiss</button>`,e+="</div>"),e+="</div>"),e+="</div>",e}function S(t,n){if(!t){console.error("Messages container not found");return}n.length===0?t.innerHTML=P():t.innerHTML=n.map((e,i)=>G(e,i)).join(""),t.scrollTop=t.scrollHeight}async function K(t,n,e,i="chat"){var r,c,u,f,l;const s=((l=(((f=(u=(c=(r=Statamic.$store)==null?void 0:r.state)==null?void 0:c.statamic)==null?void 0:u.config)==null?void 0:f.altAiConfig)||{}).endpoints)==null?void 0:l.chat)||"/cp/alt-ai/chat",a=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":Statamic.$config.get("csrfToken"),"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({message:t,conversation_history:n.slice(-10).map(d=>({role:d.role,content:d.content})),context:e,mode:i})});if(!a.ok)throw new Error(`Server error: ${a.status}`);return await a.json()}function J(t){return t.includes(" ")||/[A-Z]/.test(t)?t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,""):t}function j(t){return Array.isArray(t)?t.length===0?!0:t.every(n=>typeof n=="object"&&(n.type==="paragraph"||n.type==="heading"||n.type==="set"||n.content)):!1}function W(t){if(!t)return[];if(typeof t=="object")if(console.warn("[textToBardFormat] Received object instead of string:",t),typeof t.content=="string")console.warn("[textToBardFormat] Extracting string from object.content"),t=t.content;else if(typeof t.text=="string")t=t.text;else return Array.isArray(t)?(console.warn("[textToBardFormat] Input is already an array, returning as-is"),t):(console.error("[textToBardFormat] Cannot extract text from object:",t),[]);return typeof t!="string"?(console.error("[textToBardFormat] Cannot convert non-string value:",typeof t,t),[]):(t=t.trim(),t.length===0?[]:t.split(/\n\n+/).filter(e=>e.trim().length>0).map(e=>{const i=e.split(`
`).filter(s=>s.trim().length>0),o=[];return i.forEach((s,a)=>{s.trim()&&o.push({type:"text",text:s.trim()}),a<i.length-1&&o.push({type:"hardBreak"})}),{type:"paragraph",content:o.length>0?o:[{type:"text",text:e.trim()}]}}))}function X(t,n){if(!t||!Array.isArray(t)||t.length===0)return console.error("No changes to apply"),{appliedCount:0,skippedCount:0,changeDetails:[]};if(!Statamic.$store||!Statamic.$store.state.publish)return console.error("Vuex store not available"),alert("Cannot apply changes: publish form store not found"),{appliedCount:0,skippedCount:0,changeDetails:[]};const e=["base","default","entry","term","global"];let i=null;for(const l of e)if(Statamic.$store.state.publish[l]){i=l;break}if(!i)return console.error("No publish module found"),alert("Cannot apply changes: publish module not found"),{appliedCount:0,skippedCount:0,changeDetails:[]};const o=[];let s=0,a=0;const r=[];t.forEach(l=>{try{let d=J(l.field),g=l.proposed_value;console.log(`
[DEBUG] ========== Processing field: "${d}" ==========`),console.log("[DEBUG] Proposed value type:",typeof g),console.log("[DEBUG] Proposed value:",g);let v=Statamic.$store.state.publish[i].values[d];if(v===void 0&&(d=l.field,v=Statamic.$store.state.publish[i].values[d]),console.log("[DEBUG] Current value type:",typeof v),console.log("[DEBUG] Current value (first 200 chars):",JSON.stringify(v).substring(0,200)),v===void 0&&!Statamic.$store.state.publish[i].values.hasOwnProperty(d)){console.warn(`⚠ Field "${d}" does not exist in the form`),r.push(`⚠ ${d} (field not found)`),a++;return}const p=j(v);if(console.log("[DEBUG] isBardField(currentValue) =",p),p?(console.log(`[DEBUG] ✓ Field "${d}" IS a Bard field - converting proposed value...`),console.log("[DEBUG] BEFORE conversion - proposed_value type:",typeof g),console.log("[DEBUG] BEFORE conversion - proposed_value:",JSON.stringify(g,null,2)),g=W(g),console.log("[DEBUG] AFTER conversion - newValue type:",typeof g),console.log("[DEBUG] AFTER conversion - newValue:",JSON.stringify(g,null,2))):console.log(`[DEBUG] ✗ Field "${d}" is NOT a Bard field - no conversion needed`),v===g||JSON.stringify(v)===JSON.stringify(g)){r.push(`⊘ ${d} (no change needed)`),a++;return}o.push({fieldHandle:d,newValue:g,isBard:j(v)}),s++,r.push(`✓ ${d}`)}catch(d){console.error(`Failed to process change for field "${l.field}":`,d),r.push(`✗ ${l.field} (${d.message})`)}});const c=l=>{console.log(`Applying field updates - Round ${l}`),o.forEach(({fieldHandle:d,newValue:g})=>{try{Statamic.$store.dispatch(`publish/${i}/setFieldValue`,{handle:d,value:g})}catch(v){console.error(`Round ${l} - Failed to apply field "${d}":`,v)}})};c(1);const u=()=>{const l=typeof Vue<"u"&&Vue.nextTick?Vue.nextTick:Statamic.$nextTick||null;l?l(()=>{setTimeout(()=>{c(2),f()},200)}):setTimeout(()=>{c(2),f()},300)},f=()=>{const l=typeof Vue<"u"&&Vue.nextTick?Vue.nextTick:Statamic.$nextTick||null;l?l(()=>{setTimeout(()=>{n&&n({appliedCount:s,skippedCount:a,changeDetails:r})},100)}):setTimeout(()=>{n&&n({appliedCount:s,skippedCount:a,changeDetails:r})},150)};return u(),{appliedCount:s,skippedCount:a,changeDetails:r}}const y={messages:[],isMinimized:!0,unreadCount:0,currentContext:{}};function Y(){try{const t=sessionStorage.getItem("ai-chat-messages");if(t)return y.messages=JSON.parse(t),y.messages}catch(t){console.error("Failed to load chat history:",t)}return[]}function B(t){try{y.messages=t,sessionStorage.setItem("ai-chat-messages",JSON.stringify(t))}catch(n){console.error("Failed to save chat history:",n)}}function Z(){y.messages=[],sessionStorage.removeItem("ai-chat-messages")}function _(t){y.messages.push(t),B(y.messages)}function b(){return y.messages}function Q(t){y.isMinimized=t,t||(y.unreadCount=0)}function z(){return y.isMinimized}function ee(){y.unreadCount++}function te(){return y.unreadCount}function T(t){y.currentContext=t}function ne(){return y.currentContext}function O(){(()=>{T(M()),Y();const n=document.createElement("div");n.id="alt-ai-chat-widget",n.className="alt-ai-chat-widget minimized",n.innerHTML=H(),document.body.appendChild(n);const e=n.querySelector(".chat-button"),i=n.querySelector(".chat-window"),o=n.querySelector(".chat-minimize"),s=n.querySelector(".chat-clear"),a=n.querySelector(".chat-messages"),r=n.querySelector(".chat-input"),c=n.querySelector(".chat-update-fields"),u=n.querySelector(".chat-send"),f=n.querySelector(".chat-badge"),l=()=>{const p=!z();Q(p),n.classList.toggle("minimized",p),i.classList.toggle("hidden",p),e.classList.toggle("hidden",!p),p||(f.classList.add("hidden"),S(a,b()),setTimeout(()=>r.focus(),100))},d=async(p="chat")=>{const m=r.value.trim();if(!m)return;T(M()),_({role:"user",content:m,mode:p}),r.value="",r.disabled=!0,u.disabled=!0,c.disabled=!0,S(a,b());const h=document.createElement("div");h.className="chat-message assistant",h.innerHTML=U(),a.appendChild(h),a.scrollTop=a.scrollHeight;try{const w=await K(m,b(),ne(),p),E={role:"assistant",content:w.message,field_updates:w.field_updates||null};_(E),z()&&(ee(),f.textContent=te(),f.classList.remove("hidden")),S(a,b())}catch(w){console.error("AI Chat error:",w),_({role:"assistant",content:"Sorry, I encountered an error. Please try again."}),S(a,b())}finally{r.disabled=!1,u.disabled=!1,c.disabled=!1,r.focus()}},g=()=>{confirm("Clear the entire conversation?")&&(Z(),S(a,b()))},v=p=>{X(p,m=>{const{appliedCount:h,skippedCount:w,changeDetails:E}=m;let x="";h>0?(x=`✓ Successfully updated ${h} field${h>1?"s":""}`,w>0&&(x+=` (${w} skipped)`),x+=`:

`+E.join(`
`),x+=`

The fields should now be updated in the form. Make sure to save the form to persist these changes.`):w>0?(x=`ℹ No changes applied - all ${w} proposed change${w>1?"s were":" was"} skipped:

`,x+=E.join(`
`),x+=`

Legend:
⊘ = No change needed (value already correct)
⚠ = Field not found in form`):x="✗ Failed to apply any changes. Check console for error details.",_({role:"assistant",content:x}),T(M()),S(a,b())})};a.addEventListener("click",p=>{if(p.target.classList.contains("apply-changes-btn")){const m=parseInt(p.target.getAttribute("data-message-index")),h=b();h[m]&&h[m].field_updates&&(h[m].field_updates.applied=!0,B(h),S(a,h),v(h[m].field_updates.changes))}if(p.target.classList.contains("cancel-changes-btn")){const m=parseInt(p.target.getAttribute("data-message-index")),h=b();h[m]&&h[m].field_updates&&(h[m].field_updates.applied=!0,B(h),S(a,h))}}),e.onclick=l,o.onclick=l,s.onclick=g,c.onclick=()=>d("update_fields"),u.onclick=()=>d(),r.onkeydown=p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),d())},S(a,b())})()}N();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",O):O();
